version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - echo "Starting preBuild phase"
            - npm install
        build:
          commands:
            - echo "Starting build phase"
            - npm run build
            - echo "Verifying output directory structure"
            - ls -la packages/frontend/out
            - echo "Checking index.html content"
            - cat packages/frontend/out/index.html | head -20
            - echo "Ensuring index.html exists at root"
            - cp packages/frontend/out/index.html packages/frontend/out/404.html
            - echo "Creating Amplify rewrites configuration"
            - echo '[{"source":"/**","target":"/index.html","status":"200"}]' > packages/frontend/out/rewrite-rules.json
            - echo '{"features":{"baseDirectory":".","redirects":true}}' > packages/frontend/out/amplify.json
            - echo "/*    /index.html   200" > packages/frontend/out/_redirects
            - |
              for htmlfile in $(find packages/frontend/out -name "*.html"); do
                if ! grep -q "__NEXT_DATA__" "$htmlfile"; then
                  echo "Adding __NEXT_DATA__ to $htmlfile"
                  sed -i 's|</head>|<script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/","query":{},"buildId":"static-export","nextExport":true,"autoExport":true,"isFallback":false}</script></head>|g' "$htmlfile"
                fi
              done
      artifacts:
        baseDirectory: packages/frontend/out
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - packages/*/node_modules/**/*