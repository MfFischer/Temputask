version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - echo "Starting preBuild phase"
            - npm --version
            - node --version
            - echo "Current directory:"
            - pwd
            - ls -la
            - echo "Installing root dependencies with npm install instead of npm ci"
            - npm install
            - echo "Installing and building shared package"
            - cd packages/shared && npm install && npm run build && cd ../..
            - echo "Installing frontend dependencies"
            - cd packages/frontend && npm install && cd ../..
        build:
          commands:
            - echo "Starting build phase"
            - cd packages/frontend
            - echo "Setting environment variables"
            - export NEXT_PUBLIC_EXPORT=true
            - export NODE_ENV=production
            - export NEXT_PUBLIC_BASEURL=$AMPLIFY_URL
            - echo "Running dev:restore"
            - npm run dev:restore
            - echo "Building Next.js application"
            - npm run build
            - echo "Verifying output directory contents"
            - ls -la out
            - ls -la out/_next || echo "No _next directory found"
            - echo "Running enhanced static export script"
            - node enhance-static-export.js
            - echo "Creating Amplify specific rewrites"
            - echo '[{"source":"/<*>","target":"/index.html","status":"200","condition":null}]' > out/rewrite-rules.json
            - echo '{"rewrites":[{"source":"/<*>","target":"/index.html","status":"200"}]}' > out/rewrite-config.json
            - echo '{"features":{"baseDirectory":".","redirects":true}}' > out/amplify.json
            - echo "Creating additional redirect files"
            - echo "/*    /index.html   200" > out/_redirects
            - echo "Build completed"
      artifacts:
        baseDirectory: packages/frontend/out
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - packages/*/node_modules/**/*
      customHeaders:
        - pattern: '**/*'
          headers:
            - key: 'Cache-Control'
              value: 'no-cache, no-store'
            - key: 'X-Frame-Options'
              value: 'SAMEORIGIN'
        - pattern: '/_next/**/*'
          headers:
            - key: 'Cache-Control'
              value: 'public, max-age=31536000, immutable'