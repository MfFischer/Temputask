version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - echo "Starting preBuild phase"
            - npm install
        build:
          commands:
            - echo "Starting build phase"
            - npm run build
            - echo "Verifying output directory structure"
            - ls -la packages/frontend/out
            - echo "Checking if index.html exists"
            - |
              if [ ! -f packages/frontend/out/index.html ]; then
                echo "Creating index.html file"
                echo '<!DOCTYPE html>' > packages/frontend/out/index.html
                echo '<html lang="en">' >> packages/frontend/out/index.html
                echo '<head>' >> packages/frontend/out/index.html
                echo '  <meta charset="utf-8" />' >> packages/frontend/out/index.html
                echo '  <meta name="viewport" content="width=device-width, initial-scale=1" />' >> packages/frontend/out/index.html
                echo '  <title>Tempu Task</title>' >> packages/frontend/out/index.html
                echo '  <script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/","query":{},"buildId":"static-export","nextExport":true,"autoExport":true,"isFallback":false}</script>' >> packages/frontend/out/index.html
                echo '  <script src="/_next/static/chunks/main.js" defer></script>' >> packages/frontend/out/index.html
                echo '  <script src="/_next/static/chunks/pages/_app.js" defer></script>' >> packages/frontend/out/index.html
                echo '  <script src="/_next/static/chunks/pages/index.js" defer></script>' >> packages/frontend/out/index.html
                echo '</head>' >> packages/frontend/out/index.html
                echo '<body>' >> packages/frontend/out/index.html
                echo '  <div id="__next"></div>' >> packages/frontend/out/index.html
                echo '</body>' >> packages/frontend/out/index.html
                echo '</html>' >> packages/frontend/out/index.html
              fi
            - echo "Creating 404.html file"
            - cp packages/frontend/out/index.html packages/frontend/out/404.html || echo "Creating 404.html directly"
            - |
              if [ ! -f packages/frontend/out/404.html ]; then
                echo '<!DOCTYPE html>' > packages/frontend/out/404.html
                echo '<html lang="en">' >> packages/frontend/out/404.html
                echo '<head>' >> packages/frontend/out/404.html
                echo '  <meta charset="utf-8" />' >> packages/frontend/out/404.html
                echo '  <meta name="viewport" content="width=device-width, initial-scale=1" />' >> packages/frontend/out/404.html
                echo '  <title>Tempu Task - Page Not Found</title>' >> packages/frontend/out/404.html
                echo '  <script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/404","query":{},"buildId":"static-export","nextExport":true,"autoExport":true,"isFallback":false}</script>' >> packages/frontend/out/404.html
                echo '  <script src="/_next/static/chunks/main.js" defer></script>' >> packages/frontend/out/404.html
                echo '  <script src="/_next/static/chunks/pages/_app.js" defer></script>' >> packages/frontend/out/404.html
                echo '  <script src="/_next/static/chunks/pages/index.js" defer></script>' >> packages/frontend/out/404.html
                echo '</head>' >> packages/frontend/out/404.html
                echo '<body>' >> packages/frontend/out/404.html
                echo '  <div id="__next"></div>' >> packages/frontend/out/404.html
                echo '</body>' >> packages/frontend/out/404.html
                echo '</html>' >> packages/frontend/out/404.html
              fi
            - echo "Creating Amplify rewrites configuration"
            - echo '[{"source":"/**","target":"/index.html","status":"200"}]' > packages/frontend/out/rewrite-rules.json
            - echo '{"features":{"baseDirectory":".","redirects":true}}' > packages/frontend/out/amplify.json
            - echo "/*    /index.html   200" > packages/frontend/out/_redirects
      artifacts:
        baseDirectory: packages/frontend/out
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - packages/*/node_modules/**/*